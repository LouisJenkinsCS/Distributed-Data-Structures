log_user 0
set timeout -1
set chpl_prompt "chpl-29585 # "
spawn tcsh -f
send "set prompt=\"$chpl_prompt\"\n"
expect -re "\n$chpl_prompt" {}
send "df -T . \n"
expect {
  -ex lustre {}
  -re "\n$chpl_prompt" {
    send_user "warning: Executing this program from a non-Lustre file system may cause it \nto be unlaunchable, or for file I/O to be performed on a non-local file system.\nContinue anyway? (\[y\]/n) "
    interact {
      \015           {return}
      -echo -re "y|Y" {return}
      -echo -re "n|N" {send_user "\n" ; exit 0}
      eof               {send_user "\n" ; exit 0}
                    {send_user "\n" ; exit 0}
      -echo -re "."   {send_user "\nContinue anyway? (\[y\]/n) "}
    }
    send_user  "\n"
  }
}
send "exit\n"
close
spawn qsub -z -V -I -N Chpl-uts-deq -l walltime=01:30:00 -l nodes=16
expect {
  "A project was not specified" {send_user "error: A project account must be specified via \$CHPL_LAUNCHER_ACCOUNT\n" ; exit 1}
  -ex "qsub: waiting" {}
}
expect -re "qsub:.*ready" {}
send "tcsh -f\n"
send "set prompt=\"$chpl_prompt\"\n"
expect -re "\n$chpl_prompt" {}
send "cd \$PBS_O_WORKDIR\n"
expect -re "\n$chpl_prompt" {}
send " aprun -q -cc none -d24 -n16 -N1 -j0 ./uts-deq_real -nl 16 \n"
interact -o -ex "$chpl_prompt" {return}
send "set retval=$?\n"
send "\[ \$retval = 0 \] && echo \"JOB SUCCEEDED (done)\" || echo \"JOB FAILED: \$retval (done)\"\n"
expect -ex "(done)" {}
expect -ex "(done)" {}
expect {
    -ex "JOB SUCCEEDED" { set exitval "0" }
    -re "JOB FAILED:." { set exitval "1" }
}
expect -re "\n$chpl_prompt" {}
send "exit\n"
send "exit\n"
expect -re "qsub:.*completed" {}
close
exit $exitval
